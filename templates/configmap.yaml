apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "llmdev.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "llmdev.labels" . | nindent 4 }}
data:
  sshd_config: |
    Port 22
    Protocol 2
    HostKey /etc/ssh/ssh_host_rsa_key
    HostKey /etc/ssh/ssh_host_ecdsa_key
    HostKey /etc/ssh/ssh_host_ed25519_key
    PermitRootLogin {{ .Values.ssh.permitRootLogin }}
    PasswordAuthentication {{ .Values.ssh.passwordAuthentication }}
    PubkeyAuthentication yes
    AuthorizedKeysFile /home/abc/.ssh/authorized_keys /config/.ssh/authorized_keys
    StrictModes no
    UseDNS no
    X11Forwarding yes
    PrintMotd no
    AcceptEnv LANG LC_* PATH
    Subsystem sftp /usr/lib/openssh/sftp-server
  
  10-setup-dev-environment: |
    #!/usr/bin/with-contenv bash
    echo "ðŸš€ Setting up development environment..."
    chown -R abc:abc /config/
    mkdir -p /config/.npm-global /home/abc/.ssh /config/.ssh
    
    # Setup SSH key from secret
    if [ -n "$SSH_PUBLIC_KEY" ]; then
      echo "ðŸ”‘ Setting up SSH key from secret..."
      echo "$SSH_PUBLIC_KEY" > /home/abc/.ssh/authorized_keys
      echo "$SSH_PUBLIC_KEY" > /config/.ssh/authorized_keys
      chmod 700 /home/abc/.ssh /config/.ssh
      chmod 600 /home/abc/.ssh/authorized_keys /config/.ssh/authorized_keys
      chown -R abc:abc /home/abc/.ssh
      echo "âœ… SSH key configured"
    else
      echo "âš ï¸  No SSH_PUBLIC_KEY environment variable found"
    fi
    if [ ! -f /config/.npm-global/.initialized ]; then
      su abc -c "npm config set prefix /config/.npm-global"
      echo "ðŸ“¦ Installing Claude CLI..."
      su abc -c "npm install -g @anthropic-ai/claude-code"
      touch /config/.npm-global/.initialized
      echo "âœ… Claude CLI installed successfully"
    fi
    
    echo "ðŸ”§ Exporting environment variables for SSH sessions..."
    printenv | grep -E "_API_KEY|_TOKEN|GHCR_TOKEN|GH_TOKEN|GITHUB_ACCESS_TOKEN" > /tmp/container-env-raw
    
    {
      echo "export GEMINI_API_KEY=\"$GEMINI_API_KEY\""
      echo "export GITHUB_TOKEN=\"$GITHUB_TOKEN\""
      echo "export GHCR_TOKEN=\"$GHCR_TOKEN\""
      echo "export GH_TOKEN=\"$GITHUB_TOKEN\""
      echo "export GITHUB_ACCESS_TOKEN=\"$GITHUB_TOKEN\""
      echo "export XAI_API_KEY=\"$XAI_API_KEY\""
      echo "export GROK_API_KEY=\"$GROK_API_KEY\""
      echo "export OPENAI_API_KEY=\"$OPENAI_API_KEY\""
      echo "export OPENROUTER_API_KEY=\"$OPENROUTER_API_KEY\""
      
      echo "export ANTHROPIC_API_KEY=\"$ANTHROPIC_API_KEY\""
      echo "export PERPLEXITY_API_KEY=\"$PERPLEXITY_API_KEY\""
      echo "export CONTEXT7_API_KEY=\"$CONTEXT7_API_KEY\""
      echo "export POSTGRES_USERNAME=\"$POSTGRES_USERNAME\""
      echo "export POSTGRES_PASSWORD=\"$POSTGRES_PASSWORD\""
      echo "export WIKIJS_API_URL=\"$WIKIJS_API_URL\""
      echo "export WIKIJS_TOKEN=\"$WIKIJS_TOKEN\""
      echo "export PATH=\"/config/.npm-global/bin:$PATH\""
    } > /tmp/container-env
    chmod 644 /tmp/container-env
    
    echo 'export PATH="/config/.npm-global/bin:$PATH"' > /etc/profile.d/npm-path.sh
    echo 'if [ -f /tmp/container-env ]; then source /tmp/container-env; fi' >> /etc/profile.d/npm-path.sh
    chmod 644 /etc/profile.d/npm-path.sh
    
    if [ ! -f /config/.bashrc ]; then
        {
          echo 'export PATH="/config/.npm-global/bin:$PATH"'
          echo 'export HOME="/config"'
          echo 'if [ -f /etc/profile.d/npm-path.sh ]; then'
          echo '    source /etc/profile.d/npm-path.sh'
          echo 'fi'
          echo 'if [ -d "/appdata" ] && ([ "$PWD" = "$HOME" ] || [ "$PWD" = "/config" ]); then'
          echo '    cd /appdata'
          echo '    echo "ðŸ“ Starting in projects directory: /appdata"'
          echo 'fi'
        } > /config/.bashrc
        chown abc:abc /config/.bashrc
    elif ! grep -q "npm-path.sh" /config/.bashrc; then
        echo 'if [ -f /etc/profile.d/npm-path.sh ]; then source /etc/profile.d/npm-path.sh; fi' >> /config/.bashrc
    fi
    
    # Ensure /appdata directory change is in .bashrc for existing installations
    if [ -f /config/.bashrc ] && ! grep -q "cd /appdata" /config/.bashrc; then
        echo 'if [ -d "/appdata" ] && ([ "$PWD" = "$HOME" ] || [ "$PWD" = "/config" ]); then' >> /config/.bashrc
        echo '    cd /appdata' >> /config/.bashrc
        echo '    echo "ðŸ“ Starting in projects directory: /appdata"' >> /config/.bashrc
        echo 'fi' >> /config/.bashrc
    fi
    
    # Fix MCP server installation (runtime fix for container)
    echo "ðŸ”§ Installing missing MCP servers..."
    if [ ! -f /config/.npm-global/bin/mcp-server-perplexity-ask ]; then
        echo "ðŸ“¦ Installing correct perplexity-ask package..."
        su abc -c "npm install -g server-perplexity-ask"
    fi
    
    # Setup kubeconfig from service account
    if [ -f /var/run/secrets/kubernetes.io/serviceaccount/token ]; then
        echo "ðŸ”§ Setting up kubectl with service account..."
        mkdir -p /config/.kube
        cat > /config/.kube/config << 'KUBEEOF'
    apiVersion: v1
    kind: Config
    clusters:
    - cluster:
        certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        server: https://kubernetes.default.svc
      name: default-cluster
    contexts:
    - context:
        cluster: default-cluster
        namespace: $(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
        user: default-user
      name: default-context
    current-context: default-context
    users:
    - name: default-user
      user:
        token: $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    KUBEEOF
        chown abc:abc /config/.kube/config
        chmod 600 /config/.kube/config
        echo "âœ… kubectl configured successfully"
    fi

    # Install Goose CLI
    if [ ! -f /config/.local/bin/goose ]; then
        echo "ðŸ“¦ Installing Goose CLI..."
        GOOSE_VERSION="1.7.0"
        GOOSE_ARCH="x86_64-unknown-linux-gnu"
        GOOSE_URL="https://github.com/block/goose/releases/download/v${GOOSE_VERSION}/goose-${GOOSE_ARCH}.tar.bz2"

        su abc -c "
            cd /config
            mkdir -p .local/bin
            curl -fsSL '${GOOSE_URL}' -o goose.tar.bz2
            tar -xjf goose.tar.bz2
            mv goose .local/bin/
            chmod +x .local/bin/goose
            rm goose.tar.bz2
        "
        echo "âœ… Goose CLI installed"
    fi

    # Install Gemini CLI (Google GenAI SDK)
    if ! su abc -c "npm list -g @google/genai" >/dev/null 2>&1; then
        echo "ðŸ“¦ Installing Google GenAI SDK..."
        su abc -c "npm install -g @google/genai@1.17.0"
        echo "âœ… Google GenAI SDK installed"
    fi

    # Setup MCP configuration for project
    if [ -f /appdata/projects/llmcli/.mcp.json.template ]; then
        echo "ðŸ”§ Setting up MCP configuration from template..."
        # Export all required environment variables for substitution
        export WIKIJS_API_URL="${WIKIJS_API_URL:-https://docs.williamchambless.com}"
        export WIKIJS_TOKEN="${WIKIJS_TOKEN}"
        export GITHUB_TOKEN="${GITHUB_TOKEN}"
        export CONTEXT7_API_KEY="${CONTEXT7_API_KEY}"
        export POSTGRES_USERNAME="${POSTGRES_USERNAME}"
        export POSTGRES_PASSWORD="${POSTGRES_PASSWORD}"
        export HOMARR_API_KEY="${HOMARR_API_KEY:-}"

        # Substitute variables and create config
        envsubst < /appdata/projects/llmcli/.mcp.json.template > /appdata/projects/llmcli/.mcp.json
        chown abc:abc /appdata/projects/llmcli/.mcp.json
        echo "âœ… MCP configuration ready"
    fi
    
    echo "âœ… Development environment ready!"
