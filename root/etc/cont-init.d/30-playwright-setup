#!/usr/bin/with-contenv bash

echo "üé≠ Setting up Playwright MCP requirements"

# Check if playwright-mcp-server is requested/installed
PLAYWRIGHT_ENABLED=${PLAYWRIGHT_MCP_ENABLED:-true}

if [ "$PLAYWRIGHT_ENABLED" = "true" ]; then
    echo "üé≠ Playwright MCP enabled, installing browsers and dependencies"
    
    # Install Playwright system dependencies first (as root)
    if command -v playwright >/dev/null 2>&1; then
        echo "üì¶ Installing Playwright system dependencies..."
        # Update package list first
        apt-get update
        # Install dependencies with better error handling
        if playwright install-deps chromium; then
            echo "‚úÖ Playwright system dependencies installed"
        else
            echo "‚ö†Ô∏è Playwright system dependencies installation failed"
            echo "üîß Attempting manual essential package installation..."
            # Fallback to essential packages only
            apt-get install -y --no-install-recommends \
                ca-certificates \
                fonts-liberation \
                libasound2 \
                libatk-bridge2.0-0 \
                libc6 \
                libcairo2 \
                libcups2 \
                libdbus-1-3 \
                libexpat1 \
                libfontconfig1 \
                libgcc1 \
                libglib2.0-0 \
                libgtk-3-0 \
                libnspr4 \
                libnss3 \
                libpango-1.0-0 \
                libstdc++6 \
                libx11-6 \
                libx11-xcb1 \
                libxcb1 \
                libxcomposite1 \
                libxcursor1 \
                libxdamage1 \
                libxext6 \
                libxfixes3 \
                libxi6 \
                libxrandr2 \
                libxrender1 \
                libxss1 \
                libxtst6 \
                lsb-release \
                wget \
                xdg-utils \
                2>/dev/null || echo "‚ö†Ô∏è Some packages may not be available"
        fi
        # Clean up
        rm -rf /var/lib/apt/lists/* 2>/dev/null || true
    fi
    
    # Install Playwright browsers for abc user
    if command -v npx >/dev/null 2>&1; then
        echo "üì¶ Installing Playwright browsers..."
        
        # Install browsers as abc user to avoid permission issues
        s6-setuidgid abc bash -c "
            export HOME=/config
            export npm_config_cache=/config/.npm
            cd /config
            npx playwright install chromium
        "
        
        if [ $? -eq 0 ]; then
            echo "‚úÖ Playwright browsers installed successfully"
        else
            echo "‚ö†Ô∏è Playwright browser installation failed, but continuing..."
        fi
    else
        echo "‚ö†Ô∏è npx not found, skipping Playwright browser installation"
    fi
    
    # Verify Chrome installation (fallback to system Chrome if Playwright install failed)
    if ! s6-setuidgid abc bash -c "npx playwright --version" >/dev/null 2>&1; then
        echo "üîß Playwright CLI not working, checking system Chrome..."
        if command -v google-chrome-stable >/dev/null 2>&1; then
            echo "‚úÖ System Chrome available as fallback"
        else
            echo "‚ö†Ô∏è No Chrome browser available - Playwright MCP may not function properly"
        fi
    fi
    
    # Set Playwright-specific environment variables
    s6-setenv PLAYWRIGHT_BROWSERS_PATH "/config/.cache/ms-playwright"
    s6-setenv PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD "false"
    
    # Create browsers directory with proper permissions
    mkdir -p /config/.cache/ms-playwright
    chown -R abc:abc /config/.cache/ms-playwright
    
    echo "üé≠ Playwright setup completed"
else
    echo "üé≠ Playwright MCP disabled, skipping browser installation"
fi