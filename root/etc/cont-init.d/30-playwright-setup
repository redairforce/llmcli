#!/usr/bin/with-contenv bash

echo "üé≠ Setting up Playwright MCP requirements"

# Check if playwright-mcp-server is requested/installed
PLAYWRIGHT_ENABLED=${PLAYWRIGHT_MCP_ENABLED:-true}

if [ "$PLAYWRIGHT_ENABLED" = "true" ]; then
    echo "üé≠ Playwright MCP enabled, installing browsers and dependencies"
    
    # Install Playwright system dependencies first (as root)
    if command -v playwright >/dev/null 2>&1; then
        echo "üì¶ Installing Playwright system dependencies..."
        playwright install-deps chromium
        if [ $? -eq 0 ]; then
            echo "‚úÖ Playwright system dependencies installed"
        else
            echo "‚ö†Ô∏è Playwright system dependencies installation failed, continuing..."
        fi
    fi
    
    # Install Playwright browsers for abc user
    if command -v npx >/dev/null 2>&1; then
        echo "üì¶ Installing Playwright browsers..."
        
        # Install browsers as abc user to avoid permission issues
        s6-setuidgid abc bash -c "
            export HOME=/config
            export npm_config_cache=/config/.npm
            cd /config
            npx playwright install chromium
        "
        
        if [ $? -eq 0 ]; then
            echo "‚úÖ Playwright browsers installed successfully"
        else
            echo "‚ö†Ô∏è Playwright browser installation failed, but continuing..."
        fi
    else
        echo "‚ö†Ô∏è npx not found, skipping Playwright browser installation"
    fi
    
    # Verify Chrome installation (fallback to system Chrome if Playwright install failed)
    if ! s6-setuidgid abc bash -c "npx playwright --version" >/dev/null 2>&1; then
        echo "üîß Playwright CLI not working, checking system Chrome..."
        if command -v google-chrome-stable >/dev/null 2>&1; then
            echo "‚úÖ System Chrome available as fallback"
        else
            echo "‚ö†Ô∏è No Chrome browser available - Playwright MCP may not function properly"
        fi
    fi
    
    # Set Playwright-specific environment variables
    s6-setenv PLAYWRIGHT_BROWSERS_PATH "/config/.cache/ms-playwright"
    s6-setenv PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD "false"
    
    # Create browsers directory with proper permissions
    mkdir -p /config/.cache/ms-playwright
    chown -R abc:abc /config/.cache/ms-playwright
    
    echo "üé≠ Playwright setup completed"
else
    echo "üé≠ Playwright MCP disabled, skipping browser installation"
fi